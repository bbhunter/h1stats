#!/usr/bin/python3
#
# h1stats is a tool that compiles a csv of all h1 program stats
#
# Authors: defparam
#
# MIT License
# 
# Copyright (c) 2021 defparam
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

import sys
import requests
import base64
import json
from datetime import datetime

def diff_month(d1, d2):
    return (d1.year - d2.year) * 12 + d1.month - d2.month

def get_h1_graphql_token(hostsession):
    hdrs = {"Cookie": "__Host-session="+hostsession,
    "Content-type": "application/json", 
    "Host": "hackerone.com",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)",
    "Accept": "*/*"}
    resp = requests.get('https://hackerone.com/current_user/graphql_token',headers=hdrs)
    jsn = json.loads(resp.text)
    if (jsn['graphql_token'] == "----"):
        print("[+] Warning: could not obtain graphql token from session, reverting to public only...")
        return None
    return jsn['graphql_token']

def get_programinfo(token):
    H1_XAUTH_TOKEN = token
    PRIV_PROG_QUERY = "ewogICAgIm9wZXJhdGlvbk5hbWUiOiAiTXlQcm9ncmFtc1F1ZXJ5IiwKICAgICJ2YXJpYWJsZXMiOiB7CiAgICAgICAgIndoZXJlIjp7InN1Ym1pc3Npb25fc3RhdGUiOnsiX2VxIjoib3BlbiJ9fSwKICAgICAgICAiY291bnQiOiA1MCwKICAgICAgICAib3JkZXJCeSI6IG51bGwsCiAgICAgICAgInNlY3VyZU9yZGVyQnkiOiB7CiAgICAgICAgICAgICJzdGFydGVkX2FjY2VwdGluZ19hdCI6IHsKICAgICAgICAgICAgICAgICJfZGlyZWN0aW9uIjogIkRFU0MiCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJjdXJzb3IiOiAiIgogICAgfSwKICAgICJxdWVyeSI6ICJxdWVyeSBNeVByb2dyYW1zUXVlcnkoJGN1cnNvcjogU3RyaW5nLCAkY291bnQ6IEludCwgJHdoZXJlOiBGaWx0ZXJzVGVhbUZpbHRlcklucHV0LCAkb3JkZXJCeTogVGVhbU9yZGVySW5wdXQsICRzZWN1cmVPcmRlckJ5OiBGaWx0ZXJzVGVhbUZpbHRlck9yZGVyKSB7XG4gIG1lIHtcbiAgICBpZFxuICAgIC4uLk15SGFja2VyT25lU3ViSGVhZGVyXG4gICAgX190eXBlbmFtZVxuICB9XG4gIHRlYW1zKGZpcnN0OiAkY291bnQsIGFmdGVyOiAkY3Vyc29yLCBvcmRlcl9ieTogJG9yZGVyQnksIHNlY3VyZV9vcmRlcl9ieTogJHNlY3VyZU9yZGVyQnksIHdoZXJlOiAkd2hlcmUpIHtcbiAgICBwYWdlSW5mbyB7XG4gICAgICBlbmRDdXJzb3JcbiAgICAgIGhhc05leHRQYWdlXG4gICAgICBfX3R5cGVuYW1lXG4gICAgfVxuICAgIGVkZ2VzIHtcbiAgICAgIGN1cnNvclxuICAgICAgbm9kZSB7XG4gICAgICAgIGlkXG4gICAgICAgIGhhbmRsZVxuICAgICAgICBuYW1lXG4gICAgICAgIGN1cnJlbmN5XG4gICAgICAgIHRlYW1fcHJvZmlsZV9waWN0dXJlOiBwcm9maWxlX3BpY3R1cmUoc2l6ZTogbWVkaXVtKVxuICAgICAgICBzdWJtaXNzaW9uX3N0YXRlXG4gICAgICAgIHRyaWFnZV9hY3RpdmVcbiAgICAgICAgdXJsXG4gICAgICAgIG9mZmVyc19ib3VudGllc1xuICAgICAgYWxsb3dzX2JvdW50eV9zcGxpdHRpbmdcbiAgYXZlcmFnZV9ib3VudHlfbG93ZXJfYW1vdW50XG4gICAgICAgIGF2ZXJhZ2VfYm91bnR5X3VwcGVyX2Ftb3VudFxuICAgICAgICB0b3BfYm91bnR5X2xvd2VyX2Ftb3VudFxuICAgICAgICB0b3BfYm91bnR5X3VwcGVyX2Ftb3VudFxuICAgICAgICBmb3JtYXR0ZWRfdG90YWxfYm91bnRpZXNfcGFpZF9wcmVmaXhcbiAgICAgICAgZm9ybWF0dGVkX3RvdGFsX2JvdW50aWVzX3BhaWRfYW1vdW50XG4gICAgICAgIHJlc29sdmVkX3JlcG9ydF9jb3VudFxuICAgICAgICBmb3JtYXR0ZWRfYm91bnRpZXNfcGFpZF9sYXN0XzkwX2RheXNcbiAgICAgICAgcmVwb3J0c19yZWNlaXZlZF9sYXN0XzkwX2RheXNcbiAgICAgICAgbGFzdF9yZXBvcnRfcmVzb2x2ZWRfYXRcbiBtb3N0X3JlY2VudF9zbGFfc25hcHNob3Qge1xuICAgIGlkXG4gICAgZmlyc3RfcmVzcG9uc2VfdGltZTogYXZlcmFnZV90aW1lX3RvX2ZpcnN0X3Byb2dyYW1fcmVzcG9uc2VcbiAgICB0cmlhZ2VfdGltZTogYXZlcmFnZV90aW1lX3RvX3JlcG9ydF90cmlhZ2VcbiAgICBib3VudHlfdGltZTogYXZlcmFnZV90aW1lX3RvX2JvdW50eV9hd2FyZGVkXG4gICAgcmVzb2x1dGlvbl90aW1lOiBhdmVyYWdlX3RpbWVfdG9fcmVwb3J0X3Jlc29sdmVkXG4gICAgX190eXBlbmFtZVxuICB9XG4gICAgICAgIG9ubHlfY2xlYXJlZF9oYWNrZXJzXG4gICAgICAgIHN0YXRlXG4gICAgICAgIHN0YXJ0ZWRfYWNjZXB0aW5nX2F0XG4gICAgICAgIG51bWJlcl9vZl9yZXBvcnRzX2Zvcl91c2VyXG4gICAgICAgIG51bWJlcl9vZl92YWxpZF9yZXBvcnRzX2Zvcl91c2VyXG4gICAgICAgIGJvdW50eV9lYXJuZWRfZm9yX3VzZXJcbiAgICAgICAgbGFzdF9pbnZpdGF0aW9uX2FjY2VwdGVkX2F0X2Zvcl91c2VyXG4gICAgICAgIGJvb2ttYXJrZWRcbiAgICAgICAgZXh0ZXJuYWxfcHJvZ3JhbSB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICBfX3R5cGVuYW1lXG4gICAgICAgIH1cbiAgICAgICAgLi4uVGVhbUxpbmtXaXRoTWluaVByb2ZpbGVcbiAgICAgICAgLi4uVGVhbVRhYmxlQXZlcmFnZUJvdW50eVxuICAgICAgICAuLi5Cb3VudHlUYWJsZVRlYW1cbiAgICAgICAgLi4uVGVhbVRhYmxlTWluaW11bUJvdW50eVxuICAgICAgICAuLi5UZWFtVGFibGVSZXNvbHZlZFJlcG9ydHNcbiAgICAgICAgX190eXBlbmFtZVxuICAgICAgfVxuICAgICAgX190eXBlbmFtZVxuICAgIH1cbiAgICBfX3R5cGVuYW1lXG4gIH1cbn1cblxuZnJhZ21lbnQgQm91bnR5VGFibGVUZWFtIG9uIFRlYW0ge1xuICBpZFxuICBoYW5kbGVcbiAgYm91bnR5X3RhYmxlIHtcbiAgICBpZFxuICAgIGxvd19sYWJlbFxuICAgIG1lZGl1bV9sYWJlbFxuICAgIGhpZ2hfbGFiZWxcbiAgICBjcml0aWNhbF9sYWJlbFxuICAgIGRlc2NyaXB0aW9uXG4gICAgICAgIGJvdW50eV90YWJsZV9yb3dzKGZpcnN0OiAxMDApIHtcbiAgICAgIGVkZ2VzIHtcbiAgICAgICAgbm9kZSB7XG4gICAgICAgICAgaWRcbiAgICAgICAgICBsb3dcbiAgICAgICAgICBtZWRpdW1cbiAgICAgICAgICBoaWdoXG4gICAgICAgICAgY3JpdGljYWxcbiAgICAgICAgICBzbWFydF9yZXdhcmRzX3N0YXJ0X2F0XG4gICAgICAgICAgc3RydWN0dXJlZF9zY29wZSB7XG4gICAgICAgICAgICBpZFxuICAgICAgICAgICAgYXNzZXRfaWRlbnRpZmllclxuICAgICAgICAgICAgX190eXBlbmFtZVxuICAgICAgICAgIH1cbiAgICAgICAgICB1cGRhdGVkX2F0XG4gICAgICAgICAgX190eXBlbmFtZVxuICAgICAgICB9XG4gICAgICAgIF9fdHlwZW5hbWVcbiAgICAgIH1cbiAgICAgIF9fdHlwZW5hbWVcbiAgICB9XG4gICAgdXBkYXRlZF9hdFxuICAgIF9fdHlwZW5hbWVcbiAgfVxuICBfX3R5cGVuYW1lXG59XG5cblxuXG5mcmFnbWVudCBUZWFtTGlua1dpdGhNaW5pUHJvZmlsZSBvbiBUZWFtIHtcbiAgaWRcbiAgaGFuZGxlXG4gIG5hbWVcbiAgX190eXBlbmFtZVxufVxuXG5mcmFnbWVudCBUZWFtVGFibGVBdmVyYWdlQm91bnR5IG9uIFRlYW0ge1xuICBpZFxuICBjdXJyZW5jeVxuICBhdmVyYWdlX2JvdW50eV9sb3dlcl9hbW91bnRcbiAgYXZlcmFnZV9ib3VudHlfdXBwZXJfYW1vdW50XG4gIF9fdHlwZW5hbWVcbn1cblxuZnJhZ21lbnQgVGVhbVRhYmxlTWluaW11bUJvdW50eSBvbiBUZWFtIHtcbiAgaWRcbiAgY3VycmVuY3lcbiAgYmFzZV9ib3VudHlcbiAgX190eXBlbmFtZVxufVxuXG5mcmFnbWVudCBUZWFtVGFibGVSZXNvbHZlZFJlcG9ydHMgb24gVGVhbSB7XG4gIGlkXG4gIHJlc29sdmVkX3JlcG9ydF9jb3VudFxuICBfX3R5cGVuYW1lXG59XG5cbmZyYWdtZW50IE15SGFja2VyT25lU3ViSGVhZGVyIG9uIFVzZXIge1xuICBpZFxuICBoYXNfY2hlY2tsaXN0X2NoZWNrX3Jlc3BvbnNlc1xuICBzb2Z0X2xhdW5jaF9pbnZpdGF0aW9ucyhzdGF0ZTogb3Blbikge1xuICAgIHRvdGFsX2NvdW50XG4gICAgX190eXBlbmFtZVxuICB9XG4gIF9fdHlwZW5hbWVcbn1cbiIKfQoKCgo="
    query = json.loads(base64.b64decode(PRIV_PROG_QUERY).decode('utf-8'))
    last_cursor = ""
    
    if H1_XAUTH_TOKEN == None:
        hdrs = {"Content-type": "application/json", 
            "Host": "hackerone.com",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)",
            "Accept": "*/*"}
    else:
        hdrs = {"X-Auth-Token": H1_XAUTH_TOKEN,
            "Content-type": "application/json", 
            "Host": "hackerone.com",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)",
            "Accept": "*/*"}        
        
    print("[+] Please wait... (this may take several minutes)")
    print("[+] Collecting...\r", flush=1, end='')
    
    now = datetime.now()
    if H1_XAUTH_TOKEN == None:
        filename = "h1stats-%s-%s-%s.csv"%(str(now.year),str(now.month),str(now.day))
    else:
        filename = "h1stats-PRIVATE-%s-%s-%s.csv"%(str(now.year),str(now.month),str(now.day))
        
    with open(filename,"wb") as f:
        f.write("Program Name,URL,Program Type,Clear Program,Offers Bounties,Bounty Splitting,Max Critical,Max High,Max Medium,Max Low,Average Bounty Max,Average Bounty Min,Top Bounty Max,Top Bounty Min,Resolved Reports,Reports Received in 90 Days,Total Bounties Paid (USD),Total Bounties Paid in 90 Days (USD),Avg Time to First Response (Hours),Avg Time to Triage (Hours),Avg Time to Bounty (Hours),Avg Time to Resolution (Hours),Progam Age (Months),Days Since Last Report,Invitation Accepted Days\n".encode('utf8'))
        progcount = 0
        while(1):
            query["variables"]["cursor"] = last_cursor
            
            resp = requests.post('https://hackerone.com/graphql',headers=hdrs,data=json.dumps(query))
            data = json.loads(resp.text)
            progcount += len(data["data"]["teams"]["edges"])
            print("[+] Collecting... (%d programs)                              \r"%(progcount), flush=1, end='')
            
            if len(data["data"]["teams"]["edges"]) == 0:
                print("\n[+] Wrote all data to: %s"%filename)
                if H1_XAUTH_TOKEN != None:
                    print("[+] Warning: this data contains private information under NDA, do not publish!")
                print("[+] Done!")
                break
             
            for edge in data["data"]["teams"]["edges"]:
                last_cursor = edge["cursor"]
                url = edge["node"]["url"]
                name = edge["node"]["name"].replace(',','.')
                clear = "No"
                if edge["node"]["only_cleared_hackers"]:
                    clear = "Yes"
                bounty_splitting = "No"
                if edge["node"]["allows_bounty_splitting"]:
                    bounty_splitting = "Yes"
                    
                state = "PRIVATE"
                if edge["node"]["state"] == "public_mode":
                    state = "Public"
                
                maxcrit = "0"
                maxhigh = "0"
                maxmed = "0"
                maxlow = "0"
                if edge["node"]["bounty_table"] != None:
                    for reward in edge["node"]["bounty_table"]["bounty_table_rows"]["edges"]:
                        if reward["node"]["critical"] != None:
                            if int(reward["node"]["critical"]) > int(maxcrit):
                                maxcrit = reward["node"]["critical"]
                        if reward["node"]["high"] != None:
                            if int(reward["node"]["high"]) > int(maxhigh):
                                maxhigh = reward["node"]["high"]
                        if reward["node"]["medium"] != None:
                            if int(reward["node"]["medium"]) > int(maxmed):
                                maxmed = reward["node"]["medium"]
                        if reward["node"]["low"] != None:
                            if int(reward["node"]["low"]) > int(maxlow):
                                maxlow = reward["node"]["low"]
                if edge["node"]["average_bounty_lower_amount"] != None:
                    abla = str(edge["node"]["average_bounty_lower_amount"])
                else:
                    abla = "0"
                    
                if edge["node"]["average_bounty_upper_amount"] != None:
                    abua = str(edge["node"]["average_bounty_upper_amount"])
                else:
                    abua = "0"
                    
                if edge["node"]["top_bounty_lower_amount"] != None:
                    tbla = str(edge["node"]["top_bounty_lower_amount"])
                else:
                    tbla = "0"
                    
                if edge["node"]["top_bounty_upper_amount"] != None:
                    tbua = str(edge["node"]["top_bounty_upper_amount"])
                else:
                    tbua = "0"
                    
                if edge["node"]["formatted_total_bounties_paid_amount"] != None:
                    tbp = str(edge["node"]["formatted_total_bounties_paid_amount"])
                else:
                    tbp = "0"
                    
                if edge["node"]["formatted_bounties_paid_last_90_days"] != None:
                    tbp90 = str(edge["node"]["formatted_bounties_paid_last_90_days"])
                else:
                    tbp90 = "0"
                    
                if edge["node"]["most_recent_sla_snapshot"] != None: 
                    if edge["node"]["most_recent_sla_snapshot"]["first_response_time"] != None:
                        frt = str(edge["node"]["most_recent_sla_snapshot"]["first_response_time"])
                    else:
                        frt = "0.0"
                        
                    if edge["node"]["most_recent_sla_snapshot"]["triage_time"] != None:
                        tt = str(edge["node"]["most_recent_sla_snapshot"]["triage_time"])
                    else:
                        tt = "0.0"
                        
                    if edge["node"]["most_recent_sla_snapshot"]["bounty_time"] != None:
                        bt = str(edge["node"]["most_recent_sla_snapshot"]["bounty_time"])
                    else:
                        bt = "0.0"
                        
                    if edge["node"]["most_recent_sla_snapshot"]["resolution_time"] != None:
                        rt = str(edge["node"]["most_recent_sla_snapshot"]["resolution_time"])
                    else:
                        rt = "0.0"
                else:
                    frt = "0.0"
                    tt = "0.0"
                    bt = "0.0"
                    rt = "0.0"
                    
                    
                rrc = edge["node"]["resolved_report_count"]
                if rrc == None:
                    rrc = 0
                    
                rrc90 = edge["node"]["reports_received_last_90_days"]
                if rrc90 == None:
                    rrc90 = 0
                    
                offers = "No"
                if edge["node"]["offers_bounties"]:
                    offers = "Yes"
                
                # last_invitation_accepted_at_for_user
                try:
                    invitation_accepted_at    = edge["node"]["last_invitation_accepted_at_for_user"][0:10]
                    terms = invitation_accepted_at.split('-')
                    invacc = str((datetime.now() - datetime(int(terms[0]),int(terms[1]),int(terms[2]))).days)
                except:
                    invacc = "N/A"

                started_accepting_at    = edge["node"]["started_accepting_at"][0:10]
                terms = started_accepting_at.split('-')
                progage = str(diff_month(datetime.now(), datetime(int(terms[0]),int(terms[1]),int(terms[2]))))
                    
                try:    
                    last_report_resolved_at    = edge["node"]["last_report_resolved_at"][0:10]
                    terms = last_report_resolved_at.split('-')
                    dslr = str((datetime.now() - datetime(int(terms[0]),int(terms[1]),int(terms[2]))).days)
                except:
                    dslr = "N/A"
                
                f.write(("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n"%(name,url,state,clear,offers,bounty_splitting,maxcrit,maxhigh,maxmed,maxlow,abua,abla,tbua,tbla,rrc,rrc90,tbp,tbp90,frt,tt,bt,rt,progage,dslr,invacc)).encode('utf8'))
            


if __name__ == "__main__":
    print("  _     _ ____  _        _       ")
    print(" | |__ / / ___|| |_ __ _| |_ ___ ")
    print(" | '_ \| \___ \| __/ _` | __/ __|")
    print(" | | | | |___) | || (_| | |_\__ \\")
    print(" |_| |_|_|____/ \__\__,_|\__|___/")
    print("")
    print("                      defparam   ")
    print("")

    if len(sys.argv) == 1:
        print("[+] No session cookie specified")
        print("[+] Collecting public data...")
        graphql_token = None
    else:
        host_session_token = sys.argv[1]
        print("[+] Using specified session cookie")
        print("[+] Collecting public and private data...")
        graphql_token = get_h1_graphql_token(host_session_token)
        
    get_programinfo(graphql_token)
